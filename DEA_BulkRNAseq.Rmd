---
title: "bulkrnaseqPDX"
output: html_document
---


```{r setup, warning=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(cache = T, warning=F, message=F)

```


```{r packages_preparation}
setwd("C:/Users/paucl/Documents/TFM/DEA")

packages <- c("dplyr","EDASeq", "stringr", "ggbio", "ggplot2","limma", "EnhancedVolcano", "biomaRt", "edgeR", "tweeDEseq", "clusterProfiler","DESeq2", "pheatmap", "fgsea")
lapply(packages, library, character.only = TRUE)
```


```{r data_loading}
## Load data
# Load counts
counts.original <- read.delim("C:/Users/paucl/Documents/TFM/dades/SERRAVIO_03_04_ProcessatCNAG/COUNTS_by_genes/COUNTS_genes_SERRAVIO_03_04", header=T)

# Load phenodata
phenodata.original <-as.data.frame( readxl::read_xlsx("C:/Users/paucl/Documents/TFM/dades/20220406SamplesInfo_VS.xlsx", sheet=1, col_names = T, trim_ws=T))

# Change phenodata variables names
colnames(phenodata.original)[colnames(phenodata.original)=="Response (R/S)"] <- "Response"
colnames(phenodata.original)[colnames(phenodata.original)=="PDX name"] <- "PDX_name"
```

As we only have PDX model and patient ID information, I create a new column with original PDX_name (so I have in the same grup the olaparib resistant and sensible coming from the same patient).

```{r modifications_on_data0} 
# Create phenodata variable Original PDX
phenodata.original$Original_PDX <- unlist(strsplit(phenodata.original$PDX_name, "OR"))

# Set Original_PDX from PDX474.7 as PDX474.1 as it is the same tumour after adquiring resistance in patient
phenodata.original$Original_PDX[grep("PDX474.7",phenodata.original$Original_PDX)] <- "PDX474.1"

# Set variables as factors in phenodata and set a reference level
cols <- c("Clinical subtype","Tumor origin","Patient ID","Alteration in HRR pathway", "Drug", "Response", "Original_PDX")
phenodata.original[,cols] <- lapply(phenodata.original[cols], factor)

# Change reference level
phenodata.original$Drug <- relevel(phenodata.original$Drug, ref="control")
phenodata.original$Response <- relevel(phenodata.original$Response, ref="Sensitive")
```

First column, containing gene metadata is splitted into ensembl_id, gene_symbol and gene_product type. Then mouse genes are removed and remaining genes are filtered by protein_coding genes. Afterwards a separate table with gene metadata is created from the information in counts table (which now contains only counts).

Samples match between phenodata and count table is checked (and in the same order)

```{r gene_metadata_creation}
# Split gene information from first column in counts
counts.original <- cbind(str_split_fixed(counts.original[,1], ",", n=3), counts.original)[,-4]

# Add names to the new columns
colnames(counts.original)[1:3] <- c("ensembl_id", "gene_symbol", "gene_product")

# Remove mouse genes
human_genes_index <- unlist(lapply(strsplit(counts.original$ensembl, "G"), "[[",1))=="ENS"
counts.original <- counts.original[human_genes_index,]

# Select protein_coding genes
counts <- counts.original %>%
  dplyr::filter(gene_product=="protein_coding")

# Assign ensembl ID as rownames
rownames(counts) <- counts[,1]

# Create separate dataframe with gene metadata
gene_metadata <- counts[,1:3]

# Remove gene metadata from counts table
counts <- counts[,-1:-3]

# Arrange by model name, so both tables are in the same sample order
phenodata.original <- arrange(phenodata.original, `Sample Barcode`)[1:68,]
counts <- counts[,order(colnames(counts))]

# Check that all samples in count table are in phenodata
sum(colnames(counts) %in% phenodata.original[,2])

# Check that samples are in the same order
sum(colnames(counts) == phenodata.original[,2])/dim(phenodata.original)[1]
```

Data is subsetted by 

```{r subsetting}
# Create variable group
phenodata <- phenodata.original%>%
  mutate(Group=as.factor(paste(Response, Drug, sep="_")))
```

The sample names are changed to PDX model name.

```{r new_column_names}
# Change names of samples
new.names <- c()
for(sample in colnames(counts)){
  new.names <- c(new.names,paste0(phenodata.original[phenodata.original[,2]==sample,4], "_",phenodata.original[phenodata.original[,2]==sample,"Drug"]))}

# Assign the names
colnames(counts) <- new.names
rownames(phenodata) <- new.names

# Save number of samples
nsamples <- nrow(phenodata)
```


After cheking that there are no NA, only those genes with more than 10 counts in at least 3 samples are kept. (Reisländer et al 2019)

```{r}
# Check that there are no NA
non_na <- complete.cases(counts)
sum(!non_na)# should be 0


# # Remove genes with less than 10 counts in more than 3 samples (Reisländer et al 2019)
drop.genes <- rowSums(counts<10) > 2 #dim(counts)[2]/5
summary(drop.genes)

# Subset 
counts <- counts[non_na & !drop.genes,]
```

Library size is computed by summarizing the total number of counts per sample and library sizes are explored by a barplot and a boxplot.

```{r}
## Data exploration
# Library size
lib.size <- colSums(counts, na.rm=T) #Total number of counts of each sample

# Check distributions by response
boxplot(lib.size~as.factor(phenodata$"Group"),col=as.factor(phenodata$"Group"))

par(mar=c(10,5,2,2)+.1)
barplot(lib.size, las=2, col=as.factor(phenodata$"Group"))
legend("topright", levels(phenodata$Group), fill=1:4)
title("Library size per sample by response")
```

TMM normalization is computed and RLE is plotted.

```{r}
# Compute CPM 
TMM <- normalizeCounts(counts, method="TMM")

rownames(TMM) <- gene_metadata[rownames(TMM), "gene_symbol"]

# Plot RLE comparison between TMM and counts
par(mar=c(10,5,2,2)+.1)
plotRLE(as.matrix(counts), 
        outline=FALSE, ylim=c(-4, 4), 
        col=as.factor(phenodata$Group), main = 'Counts', las=2)
plotRLE(as.matrix(TMM), 
        outline=FALSE, ylim=c(-4, 4), 
        col=as.factor(phenodata$Group), main = 'TMM', las=2)
```
Unsupervised data exploration with the 500 genes with higher variance across samples:
- Hierarchical Clustering
- PCA
- Pair-wise Pearson Correlation
- Heatmap

```{r exploration}
# Compute the variance of each gene across samples
V <- apply(TMM, 1, var)

# Sort the results by variance in decreasing order and select the top 500 genes 
selectedGenes <- names(V[order(V, decreasing = T)][1:500])

clust.cor.ward <- hclust(dist(t(TMM[selectedGenes,])),method="average")
plot(clust.cor.ward, main="hierarchical clustering", hang=-1,cex=0.8)

# PCA #
pcaResults <- prcomp(t(TMM))
plot(pcaResults) # PC % of variability
factoextra::fviz_pca_ind(pcaResults, geom.ind=c("point"), repel=T, habillage= phenodata$"Group", max.overlaps=5)
factoextra::fviz_pca_ind(pcaResults, geom=c("point"), habillage= factor(phenodata$Original_PDX))

# Pearson correlation pair-wise
corr_coeff <- cor(TMM, method = "pearson")
pheatmap::pheatmap(corr_coeff, main = "Pearson correlation")


annotation_col <- as.data.frame(phenodata[,grepl("Group", colnames(phenodata))])
colnames(annotation_col) <- "Group"
rownames(annotation_col) <- rownames(phenodata)
pheatmap::pheatmap(TMM[selectedGenes,], scale = "row", show_rownames = FALSE, annotation_col=annotation_col)
```

Transform some variables to factors.

```{r}
# Drop levels from phenodata.original
phenodata$Original_PDX <- factor(phenodata$Original_PDX)
```

# Model

```{r MODEL}
# Create model design
design <- as.formula(~Original_PDX+Group)

# Create a DESeq dataset object from the count matrix, the phenodata  and the design
dds0 <- DESeqDataSetFromMatrix(countData = as.matrix(counts), 
                               colData = phenodata, 
                               design = design)

# DE analysis by DESeq Negative Binomial distribution
dds <- DESeq(dds0)
```

# Contrasts
```{r CONTRASTS}
# Define contrasts
drug_sensitive <- c("Group", 'Sensitive_olaparib', 'Sensitive_control')
drug_resistant <- c("Group", 'Resistant_olaparib', 'Resistant_control')
resistance_control <- c("Group", 'Resistant_control', 'Sensitive_control')
resistance_olaparib <- c("Group", 'Sensitive_olaparib','Resistant_olaparib')

# Set contrast vector and their names
contrast.vector <- c("drug_sensitive", "drug_resistant", "resistance_control", "resistance_olaparib")
contrast_names <- c("olaparib_vs_control_allsensitive", "olaparib_vs_control_allresistant", "sensitive_vs_resistant_allcontrol", "sensitive_vs_resistant_alltreated")
names(contrast_names) <- contrast.vector

for(contrast in contrast.vector){
  # Extract DEA results and order them by pvalue
  assign(paste0("DEresults.", contrast),       
         as.data.frame(DESeq2::results(dds,
                                       contrast = get(contrast)))%>%
                                arrange(pvalue))
  
  # Add gene symbol to the results
  assign(paste0("DEresults.", contrast),
         cbind(get(paste0("DEresults.", contrast)), 
         "symbol"= gene_metadata[rownames(get(paste0("DEresults.", contrast))), 
                                 "gene_symbol"]))    
  # Pvalue histogram
  ggplot(data = get(paste0("DEresults.", contrast)), aes(x = pvalue)) + 
    geom_histogram(bins = 100)

  # QQ-plot
  GWASTools::qqPlot(get(paste0("DEresults.", contrast))$pvalue)
  # Volcano plot
  print(EnhancedVolcano(get(paste0("DEresults.", contrast)),
                  x= "log2FoldChange",
                  y= "padj",
                  lab="",
                  pCutoff = 0.05,
                  FCcutoff = 0.585,
                  title =  contrast))
  # readr::write_csv(as.data.frame(get(paste0("DEresults.",contrast))),
  #                paste0("C:/Users/paucl/Documents/TFM/DEA/results/", 
  #                       contrast, "/toptable_", 
  #                       contrast_names[contrast],".csv"),
  #                col_names=T)
}
```


# Volcano plots

```{r}
# Set contrasts
contrast.vector <- c("drug_sensitive", "drug_resistant", "resistance_control", "resistance_olaparib")
contrast_names <- c("olaparib_vs_control_allsensitive", "olaparib_vs_control_allresistant", "sensitive_vs_resistant_allcontrol", "sensitive_vs_resistant_alltreated")
names(contrast_names) <- contrast.vector

# Load DEresults
for(contrast in contrast.vector){
  assign(paste0("DEresults.", contrast),
         read.csv(paste0("C:/Users/paucl/Documents/TFM/DEA/results/",
                          contrast, "/toptable_",
                          contrast_names[contrast],".csv")))}

# Load pathways
hallmark <- gmtPathways("C:/Users/paucl/Documents/TFM/dades/collectionsets_msigdb/h.all.v7.5.1.symbols.gmt")

# Set nice names
nice_names <- read.csv("C:/Users/paucl/Documents/TFM/dades/collectionsets_msigdb/beautiful_names.csv")
names(hallmark) <- as.vector(nice_names[,2])

# Subset IFNa gene set
alpha <- hallmark$`Interferon Alpha Response`


for(contrast in contrast.vector){
  # set DEresults table
  DEresults <- get(paste0("DEresults.", contrast))
  
  # subset genes belonging to IFN alpha
  color<- DEresults[DEresults$symbol%in%alpha,]
  
  # subset genes belonging to IFN alpha and being significative
  size <- DEresults[DEresults$padj<0.05 & 
                    abs(DEresults$log2FoldChange)>0.585 &
                    DEresults$symbol%in%alpha,]
  
  # PLOT
  p <- ggplot2::ggplot(DEresults,
         aes(x = log2FoldChange,
             y = -log10(padj)))+
    theme(axis.title = element_text(face="bold"))+
    # all points
    geom_point(shape = 19, 
               color = "#919394",
               size= 0.5)+
    # green small points
    geom_point(data = color, 
               aes(x = log2FoldChange,
                   y = -log10(padj)),
               color = "#20961E",
               size= 0.5)+
    labs(x = bquote(bold(.(Log[2] ~ FC))),
         y = bquote(bold(.(-Log[10] ~ FDR))))+
    theme_classic()+
    theme(legend.position="top",
          legend.justification='left')+
    scale_fill_discrete(name="",labels=expression("IFN-"~alpha ~ "pathway"))+
    geom_hline(yintercept = -log10(0.05), linetype = 2)+
    geom_vline(xintercept = 0.585, linetype = 2)+
    geom_vline(xintercept = -0.585, linetype = 2)+
    theme(axis.line = element_line(size=0.7),
          axis.ticks = element_line(size=0.7))
    if(dim(size)[1]!=0){
      p <- p+
      # green big points
      geom_point(data = size,
                  aes(x = log2FoldChange,
                      y = -log10(padj), fill=""),
                 size = 1.5,
                 color = "#20961E")+
      # add text
      geom_label_repel(data = size,
                  aes(x = log2FoldChange,
                      y = -log10(padj),
                      label = symbol),
                 size = 3,
                 min.segment.length = 0.3)}
  print(p)
  # ggsave(paste0("C:/Users/paucl/Documents/TFM/DEA/results/", contrast,
  #             "/", "VOLCANO_", contrast_names[contrast] ,".png"),
  #      units="in", limitsize = FALSE, width=4, height=5)
  }


# Number of significant genes
for(contrast in contrast.vector){
  DEresults <- get(paste0("DEresults.", contrast))
  selectedGenes <- DEresults[DEresults$padj<0.05 & abs(DEresults$log2FoldChange)>0.585,"symbol"]
  print(paste0(contrast, " DEGS ", length(selectedGenes[!is.na(selectedGenes)])))
}

# Intersection between contrasts
length(intersect(subset(DEresults.drug_sensitive, c(padj<0.05 & abs(log2FoldChange)>0.585))$symbol, subset(DEresults.resistance_olaparib, c(padj<0.05 & abs(log2FoldChange)>0.585))$symbol))


# Heatmap
library(ComplexHeatmap)

column_ha <- HeatmapAnnotation(Group = phenodata$Group)

input <- t(scale(t(na.omit(as.data.frame(TMM)[selectedGenes,]))))
Heatmap(input, top_annotation=column_ha)

```

#######################################################################################
---------------------------------------------------------------------------------------
#######################################################################################




```{r}
# Tests with POLR2J2 and GPALPP1
TMM <- as.data.frame(TMM)

# Create a dataframe with POLR2J2 TMM and phenodata information
plotthis <- cbind.data.frame("POLR2J2"=t(TMM[grep("POLR2J2", rownames(TMM)),]), 
                             phenodata[,c("Group", "Drug", "Response", "PDX_name", "Original_PDX")])

# Look for differences in POLR2J2 expression
sensitiveALL <- subset(plotthis, Response=="Sensitive")$POLR2J2
resistantALL <- subset(plotthis, Response=="Resistant")$POLR2J2

var.test(sensitiveALL, resistantALL)

length(sensitiveALL) <- length(resistantALL)

t.test(sensitiveALL, 
       resistantALL,
       alternative = "less",
       var.equal = T)

        
# Subset samples with paired adquired resistances
plotthis <- plotthis[plotthis$Original_PDX%in%levels(plotthis$Original_PDX)[table(plotthis$Original_PDX)==4],]

# Order by PDX_name and Drug
plotthis <- plotthis[order(plotthis$PDX_name, plotthis$Drug),]

ggplot(plotthis, aes(x=Response, y=POLR2J2, fill=Response))+
  geom_boxplot()+
  geom_point(aes(group= PDX_name))+
  theme_classic()
t.test(plotthis[plotthis$Response=="Sensitive", "POLR2J2"], 
       plotthis[plotthis$Response=="Resistant", "POLR2J2"], 
       paired = T,
       alternative = "less",
       var.equal = T)



library(ComplexHeatmap)
png("C:/Users/paucl/Documents/TFM/DEA/results/heatmap_POLR2J2_GPALPP1.png", width=12, height=5, units="in", res=1024)
col_fun = circlize::colorRamp2(c(-100, 100), c("white", "black"))
column_ha <- HeatmapAnnotation(Volume = phenodata$`% Volume change`, 
                               Group = phenodata$Group,
                               col = list(Volume = col_fun, 
                                          Group = c("Sensitive_control" = "green", "Sensitive_olaparib" = "dark green", "Resistant_control" = "red", "Resistant_olaparib" = "dark red")))
input <- t(scale(t(na.omit(as.data.frame(TMM)[c("GPALPP1","POLR2J2"),])))) #"GPALPP1","POLR2J2"
Heatmap(input, top_annotation = column_ha, show_column_names=T)
dev.off()

```

```{r}
## Check which DEGs are different between drug_sensitive and resistance_olaparib

# Subset DEGS
deg.drug_sensitive.up <- pull(subset(DEresults.drug_sensitive, log2FoldChange>0.585 & padj<0.05), symbol)
deg.drug_sensitive.dw <- pull(subset(DEresults.drug_sensitive, log2FoldChange<0.585 & padj<0.05), symbol)
deg.drug_sensitive <- c(deg.drug_sensitive.up, deg.drug_sensitive.dw)


deg.resistance_olaparib.up <- pull(subset(DEresults.resistance_olaparib, log2FoldChange>0.585 & padj<0.05), symbol)
deg.resistance_olaparib.dw <- pull(subset(DEresults.resistance_olaparib, log2FoldChange<0.585 & padj<0.05), symbol)
deg.resistance_olaparib <- c(deg.resistance_olaparib.up, deg.resistance_olaparib.dw)

# Intersect and difference
inters <- intersect(deg.drug_sensitive, deg.resistance_olaparib)
diff.drug <- setdiff(deg.drug_sensitive, deg.resistance_olaparib)
diff.resist <- setdiff(deg.resistance_olaparib, deg.drug_sensitive)


up.drug <- diff.drug[diff.drug %in% deg.drug_sensitive.up]
dw.drug <- diff.drug[diff.drug %in% deg.drug_sensitive.dw]

up.resist <- diff.resist[diff.resist %in% deg.resistance_olaparib.up]
dw.resist <- diff.resist[diff.resist %in% deg.resistance_olaparib.dw]

res.list <- list("UPcommon in treated vs control AND sensitives vs resistants" = inters[inters %in% deg.drug_sensitive],
                 "UPcommon in control vs treated AND resistants vs sensitive" = inters[inters %in% deg.resistance_olaparib.dw],
                 "UPdiff in treated_sensitives vs control_sensitives" = up.drug, 
                 "UPdiff in control_sensitives vs treated_sensitives" = dw.drug, 
                 "UPdiff in sensitives_treated vs resistants_treated" = up.resist, 
                 "UPdiff in resistants_treated vs sensitives_treated" = dw.resist)

capture.output(res.list, file = "C:/Users/paucl/Documents/TFM/DEA/results/DEGs_drug_sensitive_AND_resistance_olaparib.txt")

DEresults.drug_sensitive[grep("RBL", DEresults.drug_sensitive$symbol),] # VEGFA and RBL1 downregulated in treated (vs non-treated, all sensitive)
```

